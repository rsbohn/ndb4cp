# 2025-08-31 begin ndb

## Goal

Build a lean “network database” for CircuitPython devices that stores full raw device info in CAS, and tracks a minimal device index keyed by stable device UIDs.

## Status

 `06:07 | ndb | git:main+` via `~/.codex/bin/status`.

## Core Decisions
- **Primary Key:** Use device `uid` from CircuitPython as the canonical ID.
- **Storage Model:** Keep full raw device records in CAS (sha256 hex, chelle-compatible); reference from a `devices` table.
- **Scope:** No separate “index” subcommand; top-level commands stay lean and cohesive.

## What’s Implemented
- **Project Setup:** `uv init`; `src/ndb` package; console script `ndb`.
- **.gitignore:** Standard Python, venvs, tooling caches.
- **DB Schema:** SQLite `local.db` with:
  - `cas(hash TEXT PRIMARY KEY, content TEXT CHECK(length<=4096))`
  - `devices(uid TEXT PRIMARY KEY, hostname, ip_address, device_category, cas_hash, last_seen, created_at, updated_at, deleted_at NULL)`
  - Indexes on `hostname`, `ip_address`, `device_category`.
- **CAS:** `cas put|get` with sha256 hexdigest compatible with chelle; prefix and `@hash` support for get.
- **Devices:** `put` upserts `uid` + optional `hostname`, `ip_address`, `category`, stores raw to CAS; `ls` lists devices; `get <uid>` prints raw.
- **Discover:** `discover --from <host[:port]>` fetches `http://<host>/cp/version.json`, parses and stores.
  - Supports `--password` or `CIRCUITPY_WEB_API_PASSWORD`, `--timeout`, `--retries`, `--raw`, `--debug`.
- **mDNS:** `discover --mdns` scans `_circuitpython._tcp.local.` and `_http._tcp.local.` (requires `zeroconf`), fetches `/cp/version.json` for each device.
- **Status:** `ndb status` delegates to `/home/rsbohn/.codex/bin/status`.
- **Docs:** `README` Discovery section; `AGENTS.md` Toolchain section (Python 3.12, uv, sqlite-utils).

## CLI Overview
- **Init:** `uv run -- ndb db init`
- **CAS:**
  - Put: `echo -n 'hello' | uv run -- ndb cas put`
  - Get: `uv run -- ndb cas get <hash|prefix> --show-hash`
- **Devices:**
  - Put: `uv run -- ndb put --uid <UID> --hostname <h> --ip-address <ip> --category cp --file raw.json`
  - List: `uv run -- ndb ls` or `uv run -- ndb ls --json`
  - Raw: `uv run -- ndb get <UID>`
- **Discover (single):**
  - `uv run -- ndb discover --from 192.168.0.xxx:80`
  - Debug: add `--raw --debug`, `--password <pw>`, `--timeout 2 --retries 1`
- **Discover (mDNS):**
  - Install: `uv add zeroconf`
  - Scan: `uv run -- ndb discover --mdns --mdns-duration 3`
  - Dry run: add `--dry-run`
- **Status:** `uv run -- ndb status`

## Toolchain
- **Python:** 3.12 (via `uv`)
- **uv:** project manager/runner; `uv sync`, `uv run -- …`
- **zeroconf:** for `--mdns` discovery
- **sqlite-utils (optional):** quick DB inspection via `uvx sqlite-utils …`

## Why This Shape
- **Lean interface:** Top-level commands match the primary workflow (store raw, list, fetch).
- **Stable identity:** CircuitPython UID avoids duplicate devices and brittle matching.
- **Future-friendly:** Raw CAS record preserves all details, while the `devices` table stays minimal.

## Next Steps (Optional)
- **Freshness badges:** Show “seen X min ago” in `ls`.
- **Peer sync:** Batch from a seed device’s neighbor list if available.
- **Prune/soft delete:** Surface delete controls (`soft/purge`) in CLI when needed.

This pitch lands a focused, working ndb that’s immediately useful for CircuitPython device tracking, with clear growth paths without adding complexity.
